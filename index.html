<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>SUT 결제 계산하기</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 폰트 -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <!-- QR 스캐너 -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <!-- 차트 라이브러리 -->
    <script src="https://unpkg.com/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>
    
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #f2f4f6;
            color: #191f28;
            -webkit-tap-highlight-color: transparent;
            min-height: 100dvh; 
            display: flex;
            flex-direction: column;
            align-items: center; /* 중앙 정렬 */
            justify-content: center;
        }

        /* 모바일 앱 스타일 컨테이너 (PC에서도 이 모양 유지) */
        #app-container {
            width: 100%;
            max-width: 448px; /* 모바일 폭 제한 */
            height: 100vh;
            max-height: 100vh; /* 화면 꽉 차게 */
            background-color: white;
            display: flex;
            flex-direction: column;
            position: relative;
            box-shadow: 0 0 20px rgba(0,0,0,0.1); /* PC에서 살짝 그림자 */
            overflow: hidden;
        }

        /* 스크롤 영역 설정 */
        #main-content {
            flex: 1;
            overflow-y: auto;
            padding-bottom: 140px; /* 하단 버튼 공간 확보 */
        }

        .num-font { font-variant-numeric: tabular-nums; letter-spacing: -0.5px; }

        .amount-input {
            border: none; background: transparent; font-size: 2.5rem; font-weight: 700;
            color: #333d4b; width: 100%; outline: none; padding: 0; caret-color: #9333ea; border-radius: 0;
        }
        .amount-input::placeholder { color: #b0b8c1; }

        @keyframes flash { 0% { color: #9333ea; } 100% { color: #4e5968; } }
        .price-update { animation: flash 1s ease-out; }
        
        #qr-reader { width: 100%; height: 100%; border: none !important; }
        #qr-reader video { width: 100% !important; height: 100% !important; object-fit: cover !important; border-radius: 12px; }
        #qr-reader__scan_region { background: transparent; }
        #qr-reader__dashboard_section_csr button { display: none; }
        
        .scan-frame-container { position: relative; width: 260px; height: 260px; }
        .scan-corner { position: absolute; width: 30px; height: 30px; border-color: #a855f7; border-style: solid; border-width: 5px; filter: drop-shadow(0 0 4px rgba(168, 85, 247, 0.5)); }
        .tl { top: 0; left: 0; border-right: none; border-bottom: none; border-radius: 12px 0 0 0; }
        .tr { top: 0; right: 0; border-left: none; border-bottom: none; border-radius: 0 12px 0 0; }
        .bl { bottom: 0; left: 0; border-right: none; border-top: none; border-radius: 0 0 0 12px; }
        .br { bottom: 0; right: 0; border-left: none; border-top: none; border-radius: 0 0 12px 0; }
        .laser-line { position: absolute; width: 100%; height: 4px; background: linear-gradient(90deg, transparent, #d8b4fe, #a855f7, #d8b4fe, transparent); box-shadow: 0 0 15px rgba(168, 85, 247, 0.8); top: 0; animation: radar 2.5s cubic-bezier(0.4, 0, 0.2, 1) infinite; opacity: 0.8; }
        @keyframes radar { 0% { top: 10%; opacity: 0; } 10% { opacity: 1; } 90% { opacity: 1; } 100% { top: 90%; opacity: 0; } }
        
        @keyframes pulse-purple { 0% { transform: scale(0.9); box-shadow: 0 0 0 0 rgba(147, 51, 234, 0.7); } 70% { transform: scale(1); box-shadow: 0 0 0 20px rgba(147, 51, 234, 0); } 100% { transform: scale(0.9); box-shadow: 0 0 0 0 rgba(147, 51, 234, 0); } }
        .animate-pulse-ring { animation: pulse-purple 1.5s infinite; }
        
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        /* 스크롤바 숨김 */
        #main-content::-webkit-scrollbar { display: none; }

        .glass-badge {
            background: linear-gradient(135deg, rgba(147, 51, 234, 0.9), rgba(107, 33, 168, 0.95));
            box-shadow: 0 4px 6px -1px rgba(126, 34, 206, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(4px); border: 1px solid rgba(255, 255, 255, 0.1);
            color: white; font-weight: 800; border-radius: 9999px; padding: 4px 12px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2); letter-spacing: 0.05em;
        }

        /* 슬라이더 스타일 */
        input[type=range] { -webkit-appearance: none; width: 100%; height: 36px; background: #f3f4f6; border-radius: 8px; outline: none; cursor: pointer; position: relative; overflow: hidden; background-image: linear-gradient(#9333ea, #9333ea); background-size: 20% 100%; background-repeat: no-repeat; transition: background-size 0.2s cubic-bezier(0.25, 0.1, 0.25, 1); }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 36px; width: 0px; box-shadow: none; border: none; }

        /* 할인율 버튼 스타일 */
        .discount-btn { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); border: 1px solid transparent; white-space: nowrap; }
        .discount-btn.active { background-color: #6b21a8; color: white; box-shadow: 0 4px 6px -1px rgba(107, 33, 168, 0.4); border-color: #6b21a8; transform: translateY(-1px); }
        .discount-btn.inactive { background-color: #f3e8ff; color: #7e22ce; border-color: #d8b4fe; }
        .discount-btn.inactive:hover { background-color: #e9d5ff; }

        /* 상태 뱃지 */
        .status-indicator.bg-green-500 { background-color: #22c55e; box-shadow: 0 0 8px rgba(34, 197, 94, 0.6); }
        .status-indicator.bg-yellow-400 { background-color: #facc15; }
        .status-indicator.bg-red-500 { background-color: #ef4444; }
    </style>
</head>
<body>

    <div id="app-container">
        <!-- 상단 헤더 -->
        <header class="px-6 pt-8 pb-4 shrink-0 bg-white z-10"> 
            <div class="flex justify-between items-center mb-10"> 
                <div class="flex items-center -ml-6">
                    <img src="logo.png" alt="trustre" class="h-16 w-auto object-contain z-10 -ml-2" onerror="this.style.display='none'; document.getElementById('fallback-logo').style.display='flex'">
                    <div id="fallback-logo" class="w-16 h-16 bg-purple-600 rounded-full flex items-center justify-center hidden z-10 -ml-2">
                        <i data-lucide="zap" class="w-8 h-8 text-white fill-white"></i>
                    </div>
                    <span class="font-bold text-xl text-slate-900 z-0 -ml-4">trustre</span>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="startQrScanner()" class="bg-gray-100 hover:bg-gray-200 p-2 rounded-full transition-colors active:scale-95">
                        <i data-lucide="scan-line" class="w-5 h-5 text-gray-700"></i>
                    </button>
                    <div class="bg-purple-50 px-3 py-1.5 rounded-full flex items-center gap-1.5">
                        <div id="statusIndicator" class="w-2 h-2 bg-gray-300 rounded-full status-indicator"></div>
                        <span class="text-xs font-bold text-purple-700 num-font flex items-center gap-1" id="topPriceDisplay">
                            1 SUT = ...
                        </span>
                    </div>
                </div>
            </div>
            <h1 class="text-2xl font-bold text-[#191f28] leading-tight">
                결제할 금액을<br>입력해 주세요
            </h1>
        </header>

        <!-- 메인 컨텐츠 (스크롤 영역) -->
        <div id="main-content" class="px-6">
            <div class="mt-4 relative shrink-0">
                <input type="tel" id="krwInput" class="amount-input num-font" placeholder="0" pattern="[0-9]*" inputmode="numeric" autocomplete="off">
                <span class="absolute right-0 top-1/2 -translate-y-1/2 text-2xl font-bold text-[#333d4b] pointer-events-none">원</span>
            </div>
            <div id="krwKorean" class="text-sm text-gray-400 font-medium text-right h-5 mb-2 shrink-0"></div>

            <div class="bg-[#f2f4f6] rounded-2xl p-5 mt-2 transition-all duration-300 transform scale-95 opacity-50 shrink-0 mb-8" id="resultCard">
                <div class="flex justify-between items-center mb-4">
                    <span class="text-sm text-[#4e5968] font-medium">보내야 할 코인</span>
                    <button onclick="refreshData()" class="text-xs text-[#8b95a1] flex items-center gap-1 bg-white px-2 py-1 rounded shadow-sm border border-gray-100 active:bg-gray-50">
                        <i data-lucide="refresh-cw" class="w-3 h-3" id="refreshIcon"></i>
                        <span id="refreshText">업데이트</span>
                    </button>
                </div>

                <!-- 할인율 선택 UI -->
                <div class="mb-5 bg-white p-3 rounded-xl border border-gray-100 shadow-sm flex items-center gap-3">
                    <div class="flex flex-col shrink-0 w-16">
                        <span class="text-[10px] font-bold text-slate-500 mb-0.5">할인율</span>
                        <span id="discountDisplay" class="text-lg font-black text-purple-600 leading-none">10%</span>
                    </div>
                    <div class="flex gap-1 shrink-0">
                        <button id="btn10" onclick="setDiscount(10)" class="discount-btn active w-12 h-9 text-xs font-bold rounded-lg shadow-sm">10%</button>
                        <button id="btn20" onclick="setDiscount(20)" class="discount-btn inactive w-12 h-9 text-xs font-bold rounded-lg shadow-sm">20%</button>
                    </div>
                    <div class="flex-1 relative h-9 flex items-center pl-1">
                        <input type="range" id="discountSlider" min="0" max="50" step="10" value="10" oninput="updateDiscountFromSlider(this.value)" class="w-full h-9 rounded-lg cursor-pointer">
                    </div>
                </div>

                <div class="flex items-baseline gap-1 mb-1">
                    <span id="sutAmount" class="text-3xl font-bold text-purple-600 num-font">0</span>
                    <span class="text-lg font-bold text-purple-600">SUT</span>
                </div>
                
                <div class="flex flex-col items-start">
                     <button onclick="toggleInfo()" class="text-[#8b95a1] hover:text-purple-600 transition-colors p-1 -ml-1 flex items-center gap-1">
                        <i data-lucide="info" class="w-4 h-4"></i>
                    </button>
                    <div id="infoText" class="hidden text-[11px] text-gray-500 mt-2 bg-white p-3 rounded-xl border border-gray-100 shadow-sm leading-relaxed break-keep">
                        편의성을 위해 소수점을 생략했어요. 자산에 미치는 영향은 거의 없으니 안심해도 좋아요.
                    </div>
                </div>
            </div>

            <!-- AI & Chart -->
            <div class="border-t border-gray-100 pt-8 pb-4">
                <div class="bg-gradient-to-br from-purple-50 to-white border border-purple-100 rounded-2xl p-5 mb-6 shadow-sm relative overflow-hidden">
                    <div class="flex items-center gap-3 mb-2">
                        <span class="glass-badge text-[11px]">AI</span>
                        <span class="text-xs text-gray-400 font-medium">실시간 분석</span>
                        <span class="text-[10px] text-gray-300 ml-auto" id="newsSource"></span>
                    </div>
                    <p id="aiDiagnosisText" class="text-slate-800 font-bold text-lg leading-snug break-keep">데이터 확인 중...</p>
                </div>

                <div class="mb-2 px-1 flex justify-between items-end">
                    <div>
                        <h3 class="font-bold text-slate-800 text-lg mb-1">SUT 차트</h3>
                        <p class="text-xs text-gray-400">최근 24시간 흐름</p>
                    </div>
                    <div id="lastUpdatedTime" class="text-[10px] text-gray-400 bg-gray-100 px-2 py-1 rounded-md">...</div>
                </div>

                <div class="w-full h-56 bg-white rounded-2xl overflow-hidden relative border border-gray-100 shadow-sm">
                    <div id="tvChartContainer" class="w-full h-full"></div>
                    <div id="chartLoader" class="absolute inset-0 flex items-center justify-center bg-white z-10">
                        <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-purple-600"></div>
                    </div>
                    <div id="chartError" class="absolute inset-0 flex items-center justify-center bg-gray-50 text-gray-400 text-xs hidden">
                        차트 데이터를 불러올 수 없어요
                    </div>
                </div>
                
                <div class="mt-6 bg-gray-50 p-4 rounded-xl border border-gray-100">
                    <div class="flex gap-2 items-start">
                        <i data-lucide="alert-triangle" class="w-3.5 h-3.5 text-gray-400 shrink-0 mt-0.5"></i>
                        <p class="text-[11px] text-gray-400 leading-relaxed break-keep">
                            위 차트와 AI 분석은 단순 참고용이에요. 절대 투자의 근거로 활용하지 마세요. 모든 투자 결정에 대한 책임은 본인에게 있습니다.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 하단 고정 버튼 -->
        <div class="absolute bottom-0 left-0 right-0 bg-white border-t border-gray-100 p-4 pb-6 z-30 pb-safe shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] rounded-b-none">
            <div class="flex gap-3">
                <button id="copyBtn" class="flex-1 bg-[#e5e8eb] text-[#b0b8c1] font-bold text-lg py-4 rounded-xl active:scale-[0.98] transition-all disabled:opacity-50" disabled onclick="copyResult()">수량 복사</button>
                <button id="walletBtn" class="flex-1 bg-[#e5e8eb] text-[#b0b8c1] font-bold text-lg py-4 rounded-xl active:scale-[0.98] transition-all disabled:opacity-50" disabled onclick="handleSendTransfer()">
                    <img src="https://trustwallet.com/assets/images/favicon.png" class="w-6 h-6 rounded-full inline-block mr-1" alt="Trust">
                    송금하기
                </button>
            </div>
        </div>
    </div>

    <!-- 모달들 -->
    <div id="scannerOverlay" class="fixed inset-0 z-50 hidden flex-col items-center justify-center bg-black/90 backdrop-blur-sm">
        <div class="relative w-full max-w-[300px] aspect-square rounded-3xl overflow-hidden shadow-2xl bg-black"><div id="qr-reader"></div></div>
        <button onclick="stopQrScanner()" class="mt-8 px-6 py-2 bg-white/20 text-white rounded-full text-sm font-bold">닫기</button>
    </div>
    <div id="toast" class="fixed top-6 left-1/2 -translate-x-1/2 bg-[rgba(51,61,75,0.9)] text-white px-5 py-3 rounded-full text-sm font-medium opacity-0 transition-opacity duration-300 pointer-events-none z-[90]">복사되었어요</div>

    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
        // 전역 변수
        let currentSutPrice = 0; 
        let inputAmount = '';
        let discountRate = 10;
        let chartInstance = null;
        let pastSeries = null;
        let todaySeries = null;
        let html5QrCode = null;
        let scannedAddress = '';
        let isScannerRunning = false;
        let latestNewsItem = null;

        const krwInput = document.getElementById('krwInput');
        const krwKorean = document.getElementById('krwKorean');
        const sutAmountDisplay = document.getElementById('sutAmount');
        const resultCard = document.getElementById('resultCard');
        const copyBtn = document.getElementById('copyBtn');
        const walletBtn = document.getElementById('walletBtn');
        
        // 함수 정의 (호이스팅 문제 방지 위해 최상단 배치)
        function manageDailyReset() {
            const dateKey = 'aiCommentDate';
            const historyKey = 'aiCommentHistory';
            const today = new Date().toDateString();
            const lastDate = localStorage.getItem(dateKey);
            if (lastDate !== today) {
                localStorage.setItem(historyKey, '[]');
                localStorage.setItem(dateKey, today);
            }
        }

        function refreshData() {
            fetchNews().then(() => fetchSutData());
        }

        window.addEventListener('load', function() {
            if (window.lucide) lucide.createIcons();
            manageDailyReset();
            refreshData();
            setInterval(refreshData, 300000); 
            updateSliderVisual(10);
        });

        krwInput.addEventListener('input', function(e) {
            let val = e.target.value.replace(/[^0-9]/g, '');
            if (val.length > 1 && val.startsWith('0')) val = val.substring(1);
            inputAmount = val;
            e.target.value = val ? Number(val).toLocaleString() : '';
            updateScreenState();
        });

        function setDiscount(rate) {
            discountRate = rate;
            updateDiscountUI(rate); 
            calculate();
        }

        function updateDiscountFromSlider(val) {
            discountRate = parseInt(val);
            updateDiscountUI(discountRate, true); 
            calculate();
        }

        function updateDiscountUI(rate, isSlider = false) {
            document.getElementById('discountDisplay').innerText = `${rate}%`;
            if(!isSlider) document.getElementById('discountSlider').value = rate;
            
            const btn10 = document.getElementById('btn10');
            const btn20 = document.getElementById('btn20');
            
            const active = "discount-btn active w-12 h-9 text-xs font-bold rounded-lg shadow-sm transition-all active:scale-95";
            const inactive = "discount-btn inactive w-12 h-9 text-xs font-bold rounded-lg shadow-sm transition-all active:scale-95";
            
            if (rate === 10) { btn10.className = active; btn20.className = inactive; }
            else if (rate === 20) { btn10.className = inactive; btn20.className = active; }
            else { btn10.className = inactive; btn20.className = inactive; }
            
            updateSliderVisual(rate);
        }

        function updateSliderVisual(val) {
            const percentage = (val / 50) * 100;
            document.getElementById('discountSlider').style.backgroundSize = `${percentage}% 100%`;
        }

        function updateScreenState() {
            if (!inputAmount || inputAmount === '0') {
                krwKorean.innerText = '';
                resultCard.classList.add('opacity-50', 'scale-95');
                resultCard.classList.remove('opacity-100', 'scale-100', 'bg-purple-50');
                resultCard.classList.add('bg-[#f2f4f6]');
                copyBtn.disabled = true;
                walletBtn.disabled = true;
                // 스타일 제거
                copyBtn.classList.add('bg-[#e5e8eb]', 'text-[#b0b8c1]');
                copyBtn.classList.remove('bg-gray-200', 'text-gray-800');
                walletBtn.classList.add('bg-[#e5e8eb]', 'text-[#b0b8c1]');
                walletBtn.classList.remove('bg-purple-600', 'text-white');
                sutAmountDisplay.innerText = '0';
            } else {
                const numVal = Number(inputAmount);
                krwKorean.innerText = convertToKoreanNumber(numVal) + '원';
                resultCard.classList.remove('opacity-50', 'scale-95', 'bg-[#f2f4f6]');
                resultCard.classList.add('opacity-100', 'scale-100', 'bg-purple-50');
                copyBtn.disabled = false;
                walletBtn.disabled = false;
                // 스타일 추가
                copyBtn.classList.remove('bg-[#e5e8eb]', 'text-[#b0b8c1]');
                copyBtn.classList.add('bg-gray-200', 'text-gray-800');
                walletBtn.classList.remove('bg-[#e5e8eb]', 'text-[#b0b8c1]');
                walletBtn.classList.add('bg-purple-600', 'text-white');
                calculate();
            }
        }

        // Data & API
        async function fetchSutData() {
            const refreshIcon = document.getElementById('refreshIcon');
            if(refreshIcon) refreshIcon.classList.add('animate-spin');
            
            try {
                // 병렬 호출
                const [chartRes, priceRes] = await Promise.allSettled([
                    fetch('https://api.coingecko.com/api/v3/coins/super-trust/market_chart?vs_currency=krw&days=1'),
                    fetch('https://api.coingecko.com/api/v3/simple/token_price/polygon-pos?contract_addresses=0x98965474ecbec2f532f1f780ee37b0b05f77ca55&vs_currencies=krw&include_24hr_change=true')
                ]);

                // 가격 처리 (필수)
                if (priceRes.status === 'fulfilled' && priceRes.value.ok) {
                    const priceData = await priceRes.value.json();
                    if (priceData['0x98965474ecbec2f532f1f780ee37b0b05f77ca55']) {
                        const info = priceData['0x98965474ecbec2f532f1f780ee37b0b05f77ca55'];
                        currentSutPrice = info.krw;
                        updatePriceDisplay(currentSutPrice);
                        analyzeAndGenerateMessage(info.krw_24h_change);
                    }
                } else {
                     // 가격 실패시 DexScreener 시도
                     fetchDexPrice();
                }

                // 차트 처리 (옵션)
                if (chartRes.status === 'fulfilled' && chartRes.value.ok) {
                    const chartDataRaw = await chartRes.value.json();
                    if (chartDataRaw.prices && chartDataRaw.prices.length > 0) {
                        const chartData = chartDataRaw.prices.map(d => ({ time: Math.floor(d[0]/1000), value: d[1] }));
                        // Time fill
                        const lastTime = chartData[chartData.length-1].time;
                        const now = Math.floor(Date.now()/1000);
                        if(now - lastTime > 60) chartData.push({time: now, value: currentSutPrice || chartData[chartData.length-1].value});
                        else chartData[chartData.length-1].value = currentSutPrice || chartData[chartData.length-1].value;
                        
                        renderTradingViewChart(chartData);
                    }
                } else {
                    document.getElementById('chartLoader').classList.add('hidden');
                    document.getElementById('chartError').classList.remove('hidden');
                }

            } catch (error) {
                console.error(error);
                fetchDexPrice(); // Fallback
            } finally {
                if(refreshIcon) refreshIcon.classList.remove('animate-spin');
            }
        }

        async function fetchDexPrice() {
            try {
                const res = await fetch('https://api.dexscreener.com/latest/dex/tokens/0x98965474ecbec2f532f1f780ee37b0b05f77ca55');
                const data = await res.json();
                if(data.pairs && data.pairs.length > 0) {
                    const pair = data.pairs[0];
                    currentSutPrice = parseFloat(pair.priceUsd) * 1450; // Fallback Rate
                    updatePriceDisplay(currentSutPrice);
                    analyzeAndGenerateMessage(pair.priceChange.h24);
                }
            } catch(e) {
                document.getElementById('topPriceDisplay').innerText = "연결 실패";
            }
        }

        function updatePriceDisplay(price) {
            document.getElementById('topPriceDisplay').innerText = `1 SUT = ${price.toLocaleString()} KRW`;
            document.getElementById('statusIndicator').className = "w-2 h-2 bg-green-500 rounded-full animate-pulse";
            const now = new Date().toLocaleTimeString('ko-KR', {timeZone: 'Asia/Seoul', hour: '2-digit', minute:'2-digit'});
            document.getElementById('lastUpdatedTime').innerText = `업데이트됨 (${now})`;
            if(inputAmount) calculate();
        }

        function calculate() {
            if (!inputAmount || currentSutPrice === 0) {
                sutAmountDisplay.innerText = '0';
                return;
            }
            const krw = parseInt(inputAmount);
            const discountedKrw = krw * ((100 - discountRate) / 100);
            const rawSut = discountedKrw / currentSutPrice;
            const roundedSut = Math.ceil(rawSut * 1000) / 1000;
            sutAmountDisplay.innerText = roundedSut.toLocaleString(undefined, { minimumFractionDigits: 3, maximumFractionDigits: 3 });
        }

        // News & AI
        async function fetchNews() {
            try {
                const rssUrl = encodeURIComponent("https://news.google.com/rss/search?q=SUT+coin+OR+SuperTrust+OR+L2U+platform&hl=ko&gl=KR&ceid=KR:ko");
                const res = await fetch(`https://api.rss2json.com/v1/api.json?rss_url=${rssUrl}`);
                const data = await res.json();
                if (data.items?.length > 0) {
                     const now = Date.now();
                     const recent = data.items.filter(i => (now - new Date(i.pubDate).getTime()) < 259200000); // 3 days
                     if (recent.length > 0) latestNewsItem = { title: cleanNewsTitle(recent[0].title), link: recent[0].link };
                }
            } catch (e) {}
        }
        function cleanNewsTitle(t) { return t.replace(/[\(\[\{].*?[\)\]\}]/g, '').trim(); }
        
        function analyzeAndGenerateMessage(change) {
            const aiText = document.getElementById('aiDiagnosisText');
            if (latestNewsItem && !localStorage.getItem('sutPay_newsSeen')) {
                 aiText.innerHTML = `<span class="inline-flex items-center gap-1 text-purple-600 font-bold mr-1"><i data-lucide="newspaper" class="w-4 h-4"></i></span> ${latestNewsItem.title}`;
                 if(window.lucide) lucide.createIcons();
                 return;
            }
            
            const absChange = Math.abs(change).toFixed(2);
            let category = change >= 5 ? 'surge' : (change >= 0 ? 'rise' : (change >= -5 ? 'drop' : 'plunge'));
            const pctStr = `<span class="text-sm font-medium ml-1 text-slate-500">(+${absChange}%)</span>`;
            
            const templates = {
                surge: [[`강한 상승 흐름이 확인되고 있어요 ${pctStr}`]],
                rise: [[`안정적인 흐름을 유지하고 있어요 ${pctStr}`]],
                drop: [[`가격이 소폭 조정 받고 있어요. 결제하기 좋은 타이밍이에요`]],
                plunge: [[`가격 조정 폭이 커요. 지금이 스마트한 소비 기회예요`]]
            };
            aiText.innerHTML = templates[category][0][0];
        }

        // Chart
        function renderTradingViewChart(data) {
            const container = document.getElementById('tvChartContainer');
            if(!container) return;
            document.getElementById('chartLoader').classList.add('hidden');
            document.getElementById('chartError').classList.add('hidden');
            
            if (!window.LightweightCharts) return;

            if (!chartInstance) {
                chartInstance = window.LightweightCharts.createChart(container, {
                    layout: { background: { type: 'solid', color: 'transparent' }, textColor: '#9ca3af' },
                    grid: { vertLines: { visible: false }, horzLines: { visible: false } },
                    rightPriceScale: { borderVisible: false },
                    timeScale: { borderVisible: false, timeVisible: true, secondsVisible: false },
                    crosshair: { vertLine: { labelBackgroundColor: '#9333ea' }, horzLine: { labelBackgroundColor: '#9333ea' } },
                    handleScroll: false, handleScale: false
                });
                pastSeries = chartInstance.addAreaSeries({ topColor: 'rgba(156, 163, 175, 0.4)', bottomColor: 'rgba(156, 163, 175, 0.0)', lineColor: '#9ca3af', lineWidth: 2, crosshairMarkerVisible: false });
                todaySeries = chartInstance.addAreaSeries({ topColor: 'rgba(147, 51, 234, 0.2)', bottomColor: 'rgba(147, 51, 234, 0.0)', lineColor: '#9333ea', lineWidth: 2 });
                new ResizeObserver(entries => { if(entries.length) { const r = entries[0].contentRect; chartInstance.applyOptions({width: r.width, height: r.height}); } }).observe(container);
            }
            
            // Date Split (KST)
            const now = new Date();
            const kstOptions = { timeZone: 'Asia/Seoul', year: 'numeric', month: '2-digit', day: '2-digit' };
            const todayStr = new Intl.DateTimeFormat('ko-KR', kstOptions).format(now);
            const pastData=[], todayData=[];
            
            // Min/Max
            let minVal=data[0].value, maxVal=data[0].value;
            let minTime=data[0].time, maxTime=data[0].time;
            data.forEach(d => {
                if(d.value < minVal) { minVal=d.value; minTime=d.time; }
                if(d.value > maxVal) { maxVal=d.value; maxTime=d.time; }
                
                const date = new Date(d.time*1000);
                if(new Intl.DateTimeFormat('ko-KR', kstOptions).format(date) === todayStr) todayData.push(d); else pastData.push(d);
            });
            
            if(pastData.length>0 && todayData.length>0) todayData.unshift(pastData[pastData.length-1]);
            
            if(pastSeries) pastSeries.setData(pastData);
            if(todaySeries) {
                todaySeries.setData(todayData);
                const markers = [
                    { time: minTime, position: 'belowBar', color: '#3b82f6', shape: 'circle', size: 0.4 },
                    { time: maxTime, position: 'aboveBar', color: '#ef4444', shape: 'circle', size: 0.4 }
                ];
                // Filter markers for today only (optional, or add to respective series)
                todaySeries.setMarkers(markers.filter(m => new Intl.DateTimeFormat('ko-KR', kstOptions).format(new Date(m.time*1000)) === todayStr));
            }
            chartInstance.timeScale().fitContent();
        }

        // Utils
        function toggleInfo() { const el = document.getElementById('infoText'); if(el) el.classList.toggle('hidden'); }
        function convertToKoreanNumber(n) { if(n===0)return''; const u=['','만','억','조']; let r=''; let t=n; for(let i=0;i<u.length;i++){ let c=t%10000; t=Math.floor(t/10000); if(c>0) r=c.toLocaleString()+u[i]+' '+r; } return r.trim(); }
        function disableButton(b) { b.disabled=true; b.className="flex-1 bg-[#e5e8eb] text-[#b0b8c1] font-bold text-lg py-4 rounded-xl transition-all flex items-center justify-center gap-2"; }
        function enableButton(b,bg,tc) { b.disabled=false; b.className=`flex-1 ${bg} ${tc} font-bold text-lg py-4 rounded-xl active:scale-[0.98] transition-all flex items-center justify-center gap-2 shadow-sm`; }
        function copyResult() {
             const val = sutAmountDisplay.innerText.replace(/,/g, '');
             const textArea = document.createElement("textarea"); textArea.value = val; document.body.appendChild(textArea); textArea.select(); document.execCommand("Copy"); textArea.remove();
             const t=document.getElementById('toast'); if(t){ t.innerText=val+" SUT 복사되었어요"; t.style.opacity='1'; t.style.transform='translate(-50%,0)'; setTimeout(()=>{t.style.opacity='0';t.style.transform='translate(-50%,-10px)'},2000);}
        }
        function handleSendTransfer() { window.location.href = "https://link.trustwallet.com/open"; }
        function startQrScanner() { document.getElementById('scannerOverlay').classList.remove('hidden'); document.getElementById('scannerOverlay').classList.add('flex'); if(html5QrCode){try{html5QrCode.clear()}catch{}} html5QrCode = new Html5Qrcode("qr-reader"); const config={fps:10, qrbox:(w,h)=>({width:250,height:250})}; html5QrCode.start({facingMode:"environment"}, config, (d)=>{ 
             if(isProcessingScan) return; isProcessingScan=true; 
             scannedAddress=d; 
             html5QrCode.stop().then(()=>{
                 document.getElementById('scannerOverlay').classList.add('hidden');
                 const textArea = document.createElement("textarea"); textArea.value = scannedAddress; document.body.appendChild(textArea); textArea.select(); document.execCommand("Copy"); textArea.remove();
                 alert('주소가 복사되었습니다. 지갑을 실행합니다.');
                 setTimeout(()=> window.location.href = "https://link.trustwallet.com/open", 500);
                 isProcessingScan=false;
             });
        }).catch(()=>{alert("카메라 권한 필요");}); }
        function stopQrScanner() { if(html5QrCode) html5QrCode.stop().then(()=>document.getElementById('scannerOverlay').classList.add('hidden')).catch(()=>{}); }
    </script>
</body>
</html>
