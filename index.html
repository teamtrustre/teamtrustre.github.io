<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <title>SUT ê³„ì‚°ê¸° - ìŠˆí¼íŠ¸ëŸ¬ìŠ¤íŠ¸(SuperTrust) ì‹¤ì‹œê°„ ì‹œì„¸ í™•ì¸ ë° ê³„ì‚°</title>
    <meta name="description" content="SUT(ìŠˆí¼íŠ¸ëŸ¬ìŠ¤íŠ¸) ì½”ì¸ì˜ í˜„ì¬ ê°€ê²©ê³¼ ì‹¤ì‹œê°„ ì‹œì„¸ë¥¼ í™•ì¸í•˜ê³ , í• ì¸ìœ¨ì„ ì ìš©í•˜ì—¬ ìë™ìœ¼ë¡œ ê²°ì œ ê¸ˆì•¡ì„ ê³„ì‚°í•˜ì„¸ìš”. SUT ì‹¤ì‹œê°„ ì‹œì„¸ë¡œ í¸ë¦¬í•˜ê²Œ ê³„ì‚°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.">
    <meta name="keywords" content="SUT, SUTì½”ì¸, ìŠˆí¼íŠ¸ëŸ¬ìŠ¤íŠ¸, SuperTrust, SUT ê³„ì‚°ê¸°, ì½”ì¸ ê³„ì‚°ê¸°, ì‹¤ì‹œê°„ ì‹œì„¸, ìë™ ê³„ì‚°, L2U, ë ˆì €íˆ¬ìœ , trustre, íŠ¸ëŸ¬ìŠ¤íŠ¸ë¦¬">
    <meta name="author" content="trustre">
    
    <meta property="og:type" content="website">
    <meta property="og:title" content="SUT ì‹¤ì‹œê°„ ì‹œì„¸ í™•ì¸ ë° ê³„ì‚°ê¸°">
    <meta property="og:description" content="SUTì˜ í˜„ì¬ ê°€ê²©ì„ í™•ì¸í•˜ê³  í• ì¸ìœ¨ì„ ì ìš©í•´ ìë™ ê³„ì‚°í•´ë³´ì„¸ìš”.">
    <meta property="og:site_name" content="trustre">

    <meta name="robots" content="index, follow">

    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebApplication",
      "name": "trustre",
      "alternateName": ["ìŠˆí¼íŠ¸ëŸ¬ìŠ¤íŠ¸ ê³„ì‚°ê¸°", "SUT ì½”ì¸ ê³„ì‚°ê¸°"],
      "description": "SUT(SuperTrust) ì½”ì¸ì˜ ì‹¤ì‹œê°„ KRW ê°€ê²©ì„ í™•ì¸í•˜ê³  ê²°ì œ ê¸ˆì•¡ì„ ê³„ì‚°í•˜ëŠ” ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ì…ë‹ˆë‹¤.",
      "applicationCategory": "FinanceApplication",
      "operatingSystem": "Web",
      "offers": {
        "@type": "Offer",
        "price": "0",
        "priceCurrency": "KRW"
      }
    }
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://unpkg.com/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>
    
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #f2f4f6;
            color: #191f28;
            -webkit-tap-highlight-color: transparent;
            min-height: 100dvh; 
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        #app-container {
            width: 100%;
            max-width: 448px;
            height: 100vh;
            max-height: 100vh;
            background-color: white;
            display: flex;
            flex-direction: column;
            position: relative;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        #main-content {
            flex: 1;
            overflow-y: auto;
            padding-bottom: 40px; 
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        #main-content::-webkit-scrollbar { display: none; }

        .num-font { font-variant-numeric: tabular-nums; letter-spacing: -0.5px; }

        .amount-input {
            border: none; 
            background: transparent; 
            font-size: 2.5rem; 
            font-weight: 700;
            color: #333d4b; 
            width: 30px; 
            min-width: 30px;
            outline: none; 
            padding: 0; 
            margin: 0;
            caret-color: #9333ea; 
            border-radius: 0;
            text-align: left;
        }
        .amount-input::placeholder { color: #b0b8c1; }

        @keyframes flash { 0% { color: #9333ea; } 100% { color: #4e5968; } }
        .price-update { animation: flash 1s ease-out; }
        
        #qr-reader { width: 100%; height: 100%; border: none !important; }
        #qr-reader video { width: 100% !important; height: 100% !important; object-fit: cover !important; border-radius: 12px; }
        #qr-reader__scan_region { background: transparent; }
        #qr-reader__dashboard_section_csr button { display: none; }
        
        .scan-frame-container { position: relative; width: 260px; height: 260px; }
        .scan-corner { position: absolute; width: 30px; height: 30px; border-color: #a855f7; border-style: solid; border-width: 5px; filter: drop-shadow(0 0 4px rgba(168, 85, 247, 0.5)); }
        .tl { top: 0; left: 0; border-right: none; border-bottom: none; border-radius: 12px 0 0 0; }
        .tr { top: 0; right: 0; border-left: none; border-bottom: none; border-radius: 0 12px 0 0; }
        .bl { bottom: 0; left: 0; border-right: none; border-top: none; border-radius: 0 0 0 12px; }
        .br { bottom: 0; right: 0; border-left: none; border-top: none; border-radius: 0 0 12px 0; }
        .laser-line { position: absolute; width: 100%; height: 4px; background: linear-gradient(90deg, transparent, #d8b4fe, #a855f7, #d8b4fe, transparent); box-shadow: 0 0 15px rgba(168, 85, 247, 0.8); top: 0; animation: radar 2.5s cubic-bezier(0.4, 0, 0.2, 1) infinite; opacity: 0.8; }
        @keyframes radar { 0% { top: 10%; opacity: 0; } 10% { opacity: 1; } 90% { opacity: 1; } 100% { top: 90%; opacity: 0; } }
        
        @keyframes pulse-purple { 0% { transform: scale(0.9); box-shadow: 0 0 0 0 rgba(147, 51, 234, 0.7); } 70% { transform: scale(1); box-shadow: 0 0 0 20px rgba(147, 51, 234, 0); } 100% { transform: scale(0.9); box-shadow: 0 0 0 0 rgba(147, 51, 234, 0); } }
        .animate-pulse-ring { animation: pulse-purple 1.5s infinite; }
        
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        #main-content::-webkit-scrollbar { display: none; }

        .glass-badge {
            background: linear-gradient(135deg, rgba(147, 51, 234, 0.9), rgba(107, 33, 168, 0.95));
            box-shadow: 0 4px 6px -1px rgba(126, 34, 206, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(4px); border: 1px solid rgba(255, 255, 255, 0.1);
            color: white; font-weight: 800; border-radius: 9999px; padding: 4px 12px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2); letter-spacing: 0.05em;
        }

        .vertical-slider-container {
            position: relative;
            width: 32px;
            height: 100%;
            background: #f3f4f6;
            border-radius: 999px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
        }

        input[type=range] {
            -webkit-appearance: none;
            width: 140px; 
            height: 32px;
            background: transparent;
            outline: none;
            cursor: pointer;
            transform: rotate(-90deg);
            transform-origin: center;
            background-image: linear-gradient(#9333ea, #9333ea);
            background-size: 20% 100%;
            background-repeat: no-repeat;
            transition: background-size 0.2s cubic-bezier(0.25, 0.1, 0.25, 1);
        }
        
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 32px; width: 0px; box-shadow: none; border: none;
        }

        .discount-btn {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid transparent;
            white-space: nowrap;
        }
        .discount-btn.active {
            background-color: #6b21a8; 
            color: white;
            box-shadow: 0 4px 6px -1px rgba(107, 33, 168, 0.4);
            border-color: #6b21a8;
            transform: translateY(-1px);
        }
        .discount-btn.inactive {
            background-color: #f3e8ff; 
            color: #7e22ce; 
            border-color: #d8b4fe;
        }
        .discount-btn.inactive:hover { background-color: #e9d5ff; }

        .status-indicator.bg-green-500 { background-color: #22c55e; box-shadow: 0 0 8px rgba(34, 197, 94, 0.6); }
        .status-indicator.bg-yellow-400 { background-color: #facc15; }
        .status-indicator.bg-red-500 { background-color: #ef4444; }

        .modal-label { font-size: 11px; color: #6b7280; margin-bottom: 2px; }
        .modal-value { font-size: 14px; font-weight: bold; color: #1f2937; word-break: break-all; }
        .modal-box { background: #f9fafb; padding: 12px; border-radius: 12px; margin-bottom: 8px; border: 1px solid #e5e7eb; }
    </style>
</head>
<body class="max-w-md mx-auto bg-white shadow-2xl relative">

    <!-- ìƒë‹¨ í—¤ë” -->
    <header class="px-6 pt-8 pb-4 shrink-0 bg-white z-10"> 
        <div class="flex justify-between items-center mb-10"> 
            <div class="flex items-center -ml-6">
                <img src="logo.png" alt="ìŠˆí¼íŠ¸ëŸ¬ìŠ¤íŠ¸(SuperTrust) SUT ì½”ì¸ ë¡œê³ " class="h-16 w-auto object-contain z-10 -ml-2" onerror="this.style.display='none'; document.getElementById('fallback-logo').style.display='flex'">
                <div id="fallback-logo" class="w-16 h-16 bg-purple-600 rounded-full flex items-center justify-center hidden z-10 -ml-2">
                    <i data-lucide="zap" class="w-8 h-8 text-white fill-white"></i>
                </div>
                <span class="font-bold text-xl text-slate-900 z-0 -ml-4">trustre</span>
            </div>
            
            <div class="flex items-center gap-2">
                <button onclick="startQrScanner()" class="bg-gray-100 hover:bg-gray-200 p-2 rounded-full transition-colors active:scale-95">
                    <i data-lucide="scan-line" class="w-5 h-5 text-gray-700"></i>
                </button>
                <div class="bg-purple-50 px-3 py-1.5 rounded-full flex items-center gap-1.5">
                    <div id="statusIndicator" class="w-2 h-2 bg-gray-300 rounded-full status-indicator"></div>
                    <span class="text-xs font-bold text-purple-700 num-font flex items-center gap-1" id="topPriceDisplay">
                        1 SUT = ...
                    </span>
                </div>
            </div>
        </div>
        
        <h1 class="text-2xl font-bold text-[#191f28] leading-tight text-left">
            ê²°ì œí•  ê¸ˆì•¡ì„<br>ì…ë ¥í•´ ì£¼ì„¸ìš”
        </h1>
    </header>

    <!-- ë©”ì¸ ì»¨í…ì¸  -->
    <main class="flex-1 flex flex-col px-6 overflow-y-auto pb-32">
        <!-- ì…ë ¥ì°½ ì˜ì—­ -->
        <div class="mt-4 flex items-center justify-start w-full relative pl-4">
            <input type="tel" id="krwInput" class="amount-input num-font" placeholder="0" pattern="[0-9]*" inputmode="numeric" autocomplete="off">
            <span class="text-2xl font-bold text-[#333d4b] ml-1 pointer-events-none shrink-0">ì›</span>
        </div>
        <!-- í•œê¸€ ê¸ˆì•¡ ì˜ì—­ -->
        <div id="krwKorean" class="text-sm text-gray-400 font-medium text-left h-5 mb-2 shrink-0 w-full pl-5"></div>

        <div class="bg-[#f2f4f6] rounded-2xl p-5 mt-2 transition-all duration-300 transform scale-95 opacity-50 shrink-0 mb-8" id="resultCard">
            <div class="flex justify-between items-center mb-4">
                <span class="text-sm text-[#4e5968] font-medium">ë³´ë‚´ì•¼ í•  ì½”ì¸</span>
                <button onclick="fetchSutData()" class="text-xs text-[#8b95a1] flex items-center gap-1 bg-white px-2 py-1 rounded shadow-sm border border-gray-100 active:bg-gray-50 hover:bg-gray-50 transition-colors">
                    <i data-lucide="refresh-cw" class="w-3 h-3" id="refreshIcon"></i>
                    <span id="refreshText">ì—…ë°ì´íŠ¸</span>
                </button>
            </div>

            <!-- í• ì¸ìœ¨ ì„ íƒ UI -->
            <div class="mb-5 bg-white p-4 rounded-xl border border-gray-100 shadow-sm flex items-stretch gap-4 h-[160px]">
                <div class="flex flex-col justify-between flex-1">
                    <div class="flex flex-col items-start">
                        <span class="text-[10px] font-bold text-slate-400 mb-0.5">í˜„ì¬ í• ì¸ìœ¨</span>
                        <div class="flex items-center gap-2">
                            <span id="discountDisplay" class="text-3xl font-black text-purple-600 leading-none">10%</span>
                        </div>
                    </div>
                    
                    <div class="flex flex-col gap-2 mt-2">
                        <button id="btn20" onclick="setDiscount(20)" class="discount-btn inactive w-full py-2.5 text-xs font-bold rounded-lg shadow-sm">20%</button>
                        <button id="btn10" onclick="setDiscount(10)" class="discount-btn active w-full py-2.5 text-xs font-bold rounded-lg shadow-sm">10%</button>
                    </div>
                </div>

                <div class="vertical-slider-container">
                    <input type="range" id="discountSlider" min="0" max="50" step="10" value="10" 
                           oninput="updateDiscountFromSlider(this.value)">
                    <div class="absolute bottom-3 w-full text-center text-[10px] font-bold text-gray-400 pointer-events-none">0</div>
                    <div class="absolute top-3 w-full text-center text-[10px] font-bold text-white pointer-events-none mix-blend-overlay">50</div>
                </div>
            </div>

            <div class="flex items-baseline gap-1 mb-1">
                <span id="sutAmount" class="text-3xl font-bold text-purple-600 num-font">0</span>
                <span class="text-lg font-bold text-purple-600">SUT</span>
                <button onclick="toggleInfo()" class="text-[#8b95a1] hover:text-purple-600 transition-colors p-1 ml-1 translate-y-0.5" aria-label="ë„ì›€ë§ ë³´ê¸°">
                    <i data-lucide="help-circle" class="w-4 h-4"></i>
                </button>
            </div>
            
            <div id="infoText" class="hidden text-[11px] text-gray-500 mt-2 bg-white p-3 rounded-xl border border-gray-100 shadow-sm leading-relaxed break-keep">
                í¸ì˜ì„±ì„ ìœ„í•´ ì†Œìˆ˜ì ì„ ìƒëµí–ˆì–´ìš”. ìì‚°ì— ë¯¸ì¹˜ëŠ” ì˜í–¥ì€ ê±°ì˜ ì—†ìœ¼ë‹ˆ ì•ˆì‹¬í•´ë„ ì¢‹ì•„ìš”.
            </div>

            <!-- Buttons inside card -->
            <div class="flex gap-3 mt-6">
                <button id="copyBtn" class="flex-1 bg-[#e5e8eb] text-[#b0b8c1] font-bold text-base py-2.5 rounded-xl active:scale-[0.98] transition-all disabled:opacity-50 flex items-center justify-center gap-2" disabled onclick="copyResult()">
                    ìˆ˜ëŸ‰ ë³µì‚¬
                </button>
                <button id="walletBtn" class="flex-1 bg-[#e5e8eb] text-[#b0b8c1] font-bold text-base py-2.5 rounded-xl active:scale-[0.98] transition-all disabled:opacity-50 flex items-center justify-center gap-2" disabled onclick="handleSendTransfer()">
                    <i data-lucide="send" class="w-5 h-5"></i> ì†¡ê¸ˆí•˜ê¸°
                </button>
            </div>
        </div>

        <!-- AI & Chart -->
        <div class="border-t border-gray-100 pt-8 pb-4">
            <div class="bg-gradient-to-br from-purple-50 to-white border border-purple-100 rounded-2xl p-5 mb-6 shadow-sm relative overflow-hidden">
                <div class="flex items-center gap-3 mb-2">
                    <span class="glass-badge text-[11px]">AI</span>
                    <span class="text-xs text-gray-400 font-medium">ì‹¤ì‹œê°„ ë¶„ì„</span>
                    <span class="text-[10px] text-gray-300 ml-auto" id="newsSource"></span>
                </div>
                <p id="aiDiagnosisText" class="text-slate-800 font-bold text-lg leading-snug break-keep">ë°ì´í„° í™•ì¸ ì¤‘...</p>
            </div>

            <div class="mb-2 px-1 flex justify-between items-end">
                <div>
                    <h3 class="font-bold text-slate-800 text-lg mb-1">SUT ì°¨íŠ¸</h3>
                    <p class="text-xs text-gray-400">ìµœê·¼ 24ì‹œê°„ íë¦„</p>
                </div>
                <div id="lastUpdatedTime" class="text-[10px] text-gray-400 bg-gray-100 px-2 py-1 rounded-md">
                    ì—…ë°ì´íŠ¸ ì¤‘...
                </div>
            </div>

            <div class="w-full h-56 bg-white rounded-2xl overflow-hidden relative border border-gray-100 shadow-sm">
                <div id="tvChartContainer" class="w-full h-full"></div>
                <div id="chartLoader" class="absolute inset-0 flex items-center justify-center bg-white z-10">
                    <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-purple-600"></div>
                </div>
                <div id="chartError" class="absolute inset-0 flex items-center justify-center bg-gray-50 text-gray-400 text-xs hidden">
                    ì°¨íŠ¸ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ì–´ìš”
                </div>
            </div>
            
            <div class="mt-6 bg-gray-50 p-4 rounded-xl border border-gray-100">
                <div class="flex gap-2 items-start">
                    <i data-lucide="alert-triangle" class="w-3.5 h-3.5 text-gray-400 shrink-0 mt-0.5"></i>
                    <p class="text-[11px] text-gray-400 leading-relaxed break-keep">
                        ìœ„ ì°¨íŠ¸ì™€ AI ë¶„ì„ì€ ë‹¨ìˆœ ì°¸ê³ ìš©ì´ì—ìš”. ì ˆëŒ€ íˆ¬ìì˜ ê·¼ê±°ë¡œ í™œìš©í•˜ì§€ ë§ˆì„¸ìš”. ëª¨ë“  íˆ¬ì ê²°ì •ì— ëŒ€í•œ ì±…ì„ì€ ë³¸ì¸ì—ê²Œ ìˆìŠµë‹ˆë‹¤.
                    </p>
                </div>
            </div>
        </div>
    </main>

    <!-- ëª¨ë‹¬ë“¤ -->
    <div id="scannerOverlay" class="fixed inset-0 z-50 hidden flex-col items-center justify-center bg-black/90 backdrop-blur-sm">
        <div class="relative w-full max-w-[300px] aspect-square rounded-3xl overflow-hidden shadow-2xl bg-black">
            <div id="qr-reader"></div>
            <div class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
                <div class="scan-frame-container">
                    <div class="laser-line"></div>
                    <div class="scan-corner tl"></div><div class="scan-corner tr"></div>
                    <div class="scan-corner bl"></div><div class="scan-corner br"></div>
                </div>
                <p class="text-white/90 text-sm mt-6 font-medium animate-pulse text-center">QRì½”ë“œë¥¼ ì¸ì‹ì‹œì¼œ ì£¼ì„¸ìš”</p>
            </div>
        </div>
        <button onclick="stopQrScanner()" class="mt-8 px-6 py-2 bg-white/20 text-white rounded-full text-sm font-bold backdrop-blur-md border border-white/10 hover:bg-white/30 transition-all">ë‹«ê¸°</button>
    </div>
    
    <!-- QR Scan Result Modal -->
    <div id="scanResultModal" class="fixed inset-0 bg-black/60 z-[60] hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl p-6 w-full max-w-xs text-center shadow-2xl transform transition-all scale-100">
            <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4"><i data-lucide="check" class="w-6 h-6 text-green-600"></i></div>
            <h3 class="text-xl font-bold text-gray-900 mb-2">ìŠ¤ìº” ì„±ê³µ!</h3>
            
            <div class="text-left bg-gray-50 p-4 rounded-xl border border-gray-100 mb-4">
                <div class="mb-2">
                    <p class="modal-label">ì§€ê°‘ ì£¼ì†Œ</p>
                    <p class="modal-value text-xs break-all text-gray-500" id="scanModalAddress">...</p>
                </div>
                <!-- ê¸ˆì•¡ ë¯¸ì…ë ¥ ì‹œ ìˆ¨ê¹€ -->
                <div id="scanAmountDetails" class="grid grid-cols-2 gap-2 mt-2 border-t border-gray-200 pt-2 hidden">
                    <div>
                        <p class="modal-label">ë³´ë‚¼ ìˆ˜ëŸ‰</p>
                        <p class="modal-value text-purple-600" id="scanModalSut">0 SUT</p>
                    </div>
                    <div>
                        <p class="modal-label">í™˜ì‚° ê¸ˆì•¡</p>
                        <p class="modal-value text-gray-800" id="scanModalKrw">0ì›</p>
                    </div>
                </div>
            </div>

            <div class="space-y-2">
                <button onclick="copyAndOpenWallet()" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 rounded-xl shadow-lg active:scale-95 transition-all">ì£¼ì†Œ ë³µì‚¬í•˜ê³  ì§€ê°‘ ì—´ê¸°</button>
                <button onclick="closeResultModal()" class="w-full text-gray-400 text-sm py-2">ë‹«ê¸°</button>
            </div>
        </div>
    </div>
    
    <!-- Send Modal -->
    <div id="sendModal" class="fixed inset-0 bg-black/60 z-[60] hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl p-6 w-full max-w-xs text-center shadow-2xl transform transition-all scale-100">
            <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4"><i data-lucide="send" class="w-6 h-6 text-blue-600"></i></div>
            <h3 class="text-xl font-bold text-gray-900 mb-2">ì†¡ê¸ˆ ì¤€ë¹„</h3>
            <p class="text-sm text-gray-500 mb-4">ê°¯ìˆ˜ë¥¼ ë³µì‚¬í–ˆì–´ìš”. ì•±ì„ ì¼¤ê²Œìš”.</p>

            <div class="text-left bg-gray-50 p-4 rounded-xl border border-gray-100 mb-4">
                <div class="grid grid-cols-2 gap-2">
                    <div>
                        <p class="modal-label">ë³´ë‚¼ ìˆ˜ëŸ‰</p>
                        <p class="modal-value text-purple-600" id="sendModalSut">0 SUT</p>
                    </div>
                    <div>
                        <p class="modal-label">í™˜ì‚° ê¸ˆì•¡</p>
                        <p class="modal-value text-gray-800" id="sendModalKrw">0ì›</p>
                    </div>
                </div>
            </div>
            
            <button onclick="directOpenWallet()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl shadow-lg active:scale-95 transition-all">ì§€ê¸ˆ ì§€ê°‘ ì—´ê¸°</button>
            <button onclick="document.getElementById('sendModal').classList.add('hidden')" class="w-full text-gray-400 text-sm py-2 mt-1">ë‹«ê¸°</button>
        </div>
    </div>

    <div id="manualOpenModal" class="fixed inset-0 bg-black/60 z-[80] hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl p-6 w-full max-w-xs text-center shadow-2xl transform transition-all scale-100">
            <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4"><i data-lucide="alert-circle" class="w-6 h-6 text-red-600"></i></div>
            <h3 class="text-lg font-bold text-gray-900 mb-2">ì•± ì‹¤í–‰ ì˜¤ë¥˜</h3>
            <p class="text-sm text-gray-500 mb-4 leading-relaxed text-left break-keep">ìë™ìœ¼ë¡œ ì•±ì„ ì—´ ìˆ˜ ì—†ì–´ìš”.<br><span class="font-bold text-purple-600">ì§€ê°‘ ì£¼ì†ŒëŠ” ë³µì‚¬ë˜ì—ˆìœ¼ë‹ˆ</span><br>ì•±ì„ ì§ì ‘ ì‹¤í–‰í•´ì£¼ì„¸ìš”.</p>
            <button onclick="closeManualModal()" class="w-full bg-gray-900 text-white font-bold py-3 rounded-xl shadow-lg active:scale-95 transition-all">í™•ì¸</button>
        </div>
    </div>
    
    <div id="storeRedirectModal" class="fixed inset-0 bg-black/60 z-[80] hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl p-6 w-full max-w-xs text-center shadow-2xl transform transition-all scale-100">
            <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-4"><i data-lucide="download" class="w-6 h-6 text-purple-600"></i></div>
            <h3 class="text-lg font-bold text-gray-900 mb-2">ìŠ¤í† ì–´ë¡œ ì´ë™í• ê¹Œìš”?</h3>
            <p class="text-sm text-gray-500 mb-4 leading-relaxed text-left break-keep">ì˜¤ë¥˜ë¡œ ì•±ì„ ì‹¤í–‰í•˜ì§€ ëª»í•´<br>ìŠ¤í† ì–´ë¡œ ì´ë™í• ê²Œìš”.<br><span class="text-xs text-purple-500 mt-1 block">* ê²°ì œ ìˆ˜ëŸ‰(SUT)ì€ ë³µì‚¬ë˜ì—ˆì–´ìš”.</span></p>
            <button onclick="goToStore()" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 rounded-xl shadow-lg active:scale-95 transition-all">ìŠ¤í† ì–´ë¡œ ì´ë™</button>
            <button onclick="closeStoreModal()" class="w-full text-gray-400 text-sm mt-2">ë‹«ê¸°</button>
        </div>
    </div>

    <div id="toast" class="fixed top-6 left-1/2 -translate-x-1/2 bg-[rgba(51,61,75,0.9)] text-white px-5 py-3 rounded-full text-sm font-medium opacity-0 transition-opacity duration-300 pointer-events-none z-[90]">ë³µì‚¬ë˜ì—ˆì–´ìš”</div>

    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
        // ì „ì—­ ë³€ìˆ˜
        let currentSutPrice = 0; 
        let inputAmount = '';
        let isPriceLoaded = false;
        let discountRate = 10;
        let html5QrCode;
        let scannedAddress = '';
        let isScannerRunning = false;
        let isProcessingScan = false;
        let chartInstance = null;
        let pastSeries = null;
        let todaySeries = null;
        let latestNewsItem = null;
        let priceGrade = 'D'; 
        let fetchRetryCount = 0;

        const ui = {
            krwInput: document.getElementById('krwInput'),
            krwKorean: document.getElementById('krwKorean'),
            sutAmountDisplay: document.getElementById('sutAmount'),
            priceDisplay: document.getElementById('topPriceDisplay'),
            resultCard: document.getElementById('resultCard'),
            copyBtn: document.getElementById('copyBtn'),
            walletBtn: document.getElementById('walletBtn'),
            statusIndicator: document.getElementById('statusIndicator'),
            refreshIcon: document.getElementById('refreshIcon'),
            refreshText: document.getElementById('refreshText'),
            aiText: document.getElementById('aiDiagnosisText'),
            chartLoader: document.getElementById('chartLoader'),
            chartError: document.getElementById('chartError'),
            lastUpdatedTime: document.getElementById('lastUpdatedTime'),
            newsSource: document.getElementById('newsSource'),
            discountDisplay: document.getElementById('discountDisplay'),
            discountSlider: document.getElementById('discountSlider'),
            btn10: document.getElementById('btn10'),
            btn20: document.getElementById('btn20'),
            // Modals elements
            scanModalAddress: document.getElementById('scanModalAddress'),
            scanModalSut: document.getElementById('scanModalSut'),
            scanModalKrw: document.getElementById('scanModalKrw'),
            scanAmountDetails: document.getElementById('scanAmountDetails'),
            sendModalSut: document.getElementById('sendModalSut'),
            sendModalKrw: document.getElementById('sendModalKrw')
        };

        function manageDailyReset() {
            const dateKey = 'aiCommentDate';
            const historyKey = 'aiCommentHistory';
            const today = new Date().toDateString();
            const lastDate = localStorage.getItem(dateKey);
            if (lastDate !== today) {
                localStorage.setItem(historyKey, '[]');
                localStorage.setItem(dateKey, today);
            }
        }

        window.addEventListener('load', function() {
            if (window.lucide) { lucide.createIcons(); }
            manageDailyReset();
            fetchNews().then(() => reloadData());
            setInterval(() => { fetchNews(); fetchSutData(); }, 300000); 
            updateSliderVisual(10);
            
            // [NEW] Input Width Adjuster (Init)
            adjustInputWidth();
        });

        function reloadData() {
            fetchRetryCount = 0;
            fetchSutData();
        }

        ui.krwInput.addEventListener('input', function(e) {
            let val = e.target.value.replace(/[^0-9]/g, '');
            if (val.length > 1 && val.startsWith('0')) val = val.substring(1);
            inputAmount = val;
            e.target.value = val ? Number(val).toLocaleString() : '';
            updateScreenState();
            adjustInputWidth();
        });
        
        // [NEW] Dynamic Input Width Function (Sensitive & Font Matched)
        function adjustInputWidth() {
            const val = ui.krwInput.value || ui.krwInput.placeholder;
            
            const span = document.createElement('span');
            span.style.font = window.getComputedStyle(ui.krwInput).font;
            span.style.fontWeight = window.getComputedStyle(ui.krwInput).fontWeight;
            span.style.fontSize = window.getComputedStyle(ui.krwInput).fontSize;
            span.style.letterSpacing = window.getComputedStyle(ui.krwInput).letterSpacing;
            span.style.visibility = 'hidden';
            span.style.position = 'absolute';
            span.style.whiteSpace = 'pre';
            span.innerText = val;
            document.body.appendChild(span);
            
            const width = span.offsetWidth;
            ui.krwInput.style.width = (width + 2) + 'px'; 
            
            document.body.removeChild(span);
        }

        // Discount Logic
        function setDiscount(rate) {
            discountRate = rate;
            updateDiscountUI(rate); 
            calculate();
        }

        function updateDiscountFromSlider(val) {
            discountRate = parseInt(val);
            updateDiscountUI(discountRate, true); 
            calculate();
        }

        function updateDiscountUI(rate, isSlider = false) {
            ui.discountDisplay.innerText = `${rate}%`;
            if(!isSlider) ui.discountSlider.value = rate;
            
            const active = "discount-btn active w-full py-2.5 text-xs font-bold rounded-lg shadow-sm transition-all active:scale-95";
            const inactive = "discount-btn inactive w-full py-2.5 text-xs font-bold rounded-lg shadow-sm transition-all active:scale-95";
            
            if (rate === 10) { ui.btn10.className = active; ui.btn20.className = inactive; }
            else if (rate === 20) { ui.btn10.className = inactive; ui.btn20.className = active; }
            else { ui.btn10.className = inactive; ui.btn20.className = inactive; }
            
            updateSliderVisual(rate);
        }

        function updateSliderVisual(val) {
            const percentage = (val / 50) * 100;
            ui.discountSlider.style.backgroundSize = `${percentage}% 100%`;
        }

        function updateScreenState() {
            if (!inputAmount || inputAmount === '0') {
                ui.krwKorean.innerText = '';
                ui.resultCard.classList.add('opacity-50', 'scale-95');
                ui.resultCard.classList.remove('opacity-100', 'scale-100', 'bg-purple-50');
                ui.resultCard.classList.add('bg-[#f2f4f6]');
                disableButton(ui.copyBtn);
                disableButton(ui.walletBtn);
                ui.sutAmountDisplay.innerText = '0';
            } else {
                const numVal = Number(inputAmount);
                ui.krwKorean.innerText = convertToKoreanNumber(numVal);
                ui.resultCard.classList.remove('opacity-50', 'scale-95', 'bg-[#f2f4f6]');
                ui.resultCard.classList.add('opacity-100', 'scale-100', 'bg-purple-50');
                enableButton(ui.copyBtn, 'bg-gray-200', 'text-gray-800');
                enableButton(ui.walletBtn, 'bg-purple-600', 'text-white');
                calculate();
            }
        }
        
        function convertToKoreanNumber(num) {
            if(num < 10000) return '';
            
            const units = ['', 'ë§Œ', 'ì–µ', 'ì¡°'];
            let result = '';
            let temp = num;
            
            for(let i=0; i<units.length; i++) {
                let chunk = temp % 10000;
                temp = Math.floor(temp / 10000);
                
                if(chunk > 0) {
                    let unitPart = chunk.toLocaleString();
                    if (i > 0) unitPart += units[i]; 
                    result = unitPart + (result ? ' ' + result : '');
                }
            }
            return result + 'ì›'; 
        }

        // Data & API
        function calculateQualityScore(source, data) {
            let score = 0;
            const now = Date.now();
            if (!data) return -1;
            if (source === 'coingecko') {
                if (data.prices && data.prices.length > 0) score += 50;
                const lastTime = data.prices[data.prices.length-1][0];
                if (now - lastTime < 3600000) score += 30;
            } else if (source === 'dexscreener') {
                if (data.pairs && data.pairs.length > 0) score += 40; 
            }
            return score;
        }

        async function fetchSutData(retryCount = 0) {
            if(ui.refreshIcon) ui.refreshIcon.classList.add('animate-spin');
            updateStatusUI('loading', "ë°ì´í„° í™•ì¸ ì¤‘...");
            
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 3000); 

            try {
                const cgPriceUrl = 'https://api.coingecko.com/api/v3/simple/token_price/polygon-pos?contract_addresses=0x98965474ecbec2f532f1f780ee37b0b05f77ca55&vs_currencies=krw&include_24hr_change=true';
                const cgChartUrl = 'https://api.coingecko.com/api/v3/coins/super-trust/market_chart?vs_currency=krw&days=1';
                const dexUrl = 'https://api.dexscreener.com/latest/dex/tokens/0x98965474ecbec2f532f1f780ee37b0b05f77ca55';

                const [cgPriceRes, cgChartRes, dexRes] = await Promise.allSettled([
                    fetch(cgPriceUrl, { signal: controller.signal }),
                    fetch(cgChartUrl, { signal: controller.signal }),
                    fetch(dexUrl, { signal: controller.signal })
                ]);

                clearTimeout(timeoutId);

                let cgPriceData = null, cgChartData = null, dexData = null;
                let cgScore = 0, dexScore = 0;

                if (cgPriceRes.status === 'fulfilled' && cgChartRes.status === 'fulfilled') {
                    if (cgPriceRes.value.ok && cgChartRes.value.ok) {
                        cgPriceData = await cgPriceRes.value.json();
                        cgChartData = await cgChartRes.value.json();
                        if (cgPriceData['0x98965474ecbec2f532f1f780ee37b0b05f77ca55']) {
                            cgScore = calculateQualityScore('coingecko', cgChartData);
                        }
                    }
                }

                if (dexRes.status === 'fulfilled') {
                    dexData = await dexRes.value.json();
                    dexScore = calculateQualityScore('dexscreener', dexData);
                }

                let finalPrice = 0, finalChange = 0, finalChartData = [];
                let grade = 'D';

                if (cgScore > 0 && cgScore >= dexScore) {
                    const info = cgPriceData['0x98965474ecbec2f532f1f780ee37b0b05f77ca55'];
                    finalPrice = info.krw;
                    finalChange = info.krw_24h_change;
                    finalChartData = cgChartData.prices.map(item => ({ time: Math.floor(item[0]/1000), value: item[1] }));
                    grade = 'A';
                } else if (dexScore > 0) {
                    const pair = dexData.pairs[0];
                    const usdPrice = parseFloat(pair.priceUsd);
                    finalPrice = usdPrice * 1450; 
                    finalChange = pair.priceChange.h24;
                    grade = 'C';
                    finalChartData = []; 
                } else {
                    throw new Error("All sources failed");
                }

                if(finalChartData.length > 0) {
                    const lastTime = finalChartData[finalChartData.length-1].time;
                    const now = Math.floor(Date.now()/1000);
                    if(now - lastTime > 60) finalChartData.push({time: now, value: finalPrice});
                    else finalChartData[finalChartData.length-1].value = finalPrice;
                }

                currentSutPrice = finalPrice;
                priceGrade = grade;
                isPriceLoaded = true;
                updatePriceInfoUI(grade, finalPrice);
                analyzeAndGenerateMessage(finalChange);
                updateLastTime();
                
                if (finalChartData.length > 0) {
                    let minVal=finalChartData[0].value, maxVal=finalChartData[0].value;
                    let minTime=finalChartData[0].time, maxTime=finalChartData[0].time;
                    finalChartData.forEach(item => {
                        if(item.value < minVal) { minVal=item.value; minTime=item.time; }
                        if(item.value > maxVal) { maxVal=item.value; maxTime=item.time; }
                    });
                    const markers = [
                        { time: minTime, position: 'belowBar', color: '#3b82f6', shape: 'circle', size: 0.4 },
                        { time: maxTime, position: 'aboveBar', color: '#ef4444', shape: 'circle', size: 0.4 }
                    ];
                    markers.sort((a,b)=>a.time-b.time);
                    renderTradingViewChart(finalChartData, markers);
                } else {
                    if(ui.chartLoader) ui.chartLoader.classList.add('hidden');
                    if(ui.chartError) {
                        ui.chartError.classList.remove('hidden');
                        ui.chartError.innerText = "ì°¨íŠ¸ ë°ì´í„° ì¤€ë¹„ ì¤‘ (ê°€ê²©ì€ ì •ìƒ)";
                    }
                }

            } catch (error) {
                console.error("Load Error:", error);
                if (retryCount < 1) {
                    setTimeout(() => fetchSutData(retryCount + 1), 1500);
                } else {
                    handleFetchError();
                }
            } finally {
                if(ui.refreshIcon) ui.refreshIcon.classList.remove('animate-spin');
            }
        }

        function updateStatusUI(state, msg) {
            if (state === 'loading') {
                ui.statusIndicator.className = "w-2 h-2 bg-yellow-400 rounded-full animate-pulse";
                ui.lastUpdatedTime.innerText = msg;
            } else if (state === 'error') {
                ui.statusIndicator.className = "w-2 h-2 bg-red-500 rounded-full";
            }
        }

        function updatePriceInfoUI(grade, price) {
            let displayPrice = "";
            let indicatorClass = "w-2 h-2 rounded-full ";
            
            if (grade === 'A') {
                displayPrice = `1 SUT = ${price.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})} KRW`;
                indicatorClass += "bg-green-500 animate-pulse";
            } else if (grade === 'B') {
                displayPrice = `ì•½ 1 SUT = ì•½ ${Math.round(price).toLocaleString()} KRW`;
                indicatorClass += "bg-yellow-500";
            } else if (grade === 'C') {
                displayPrice = `ìµœê·¼ ê±°ë˜ ê¸°ì¤€ (ì•½ ${Math.round(price)}ì›)`;
                indicatorClass += "bg-orange-500";
            }
            
            ui.priceDisplay.innerText = displayPrice;
            ui.statusIndicator.className = indicatorClass;
            if(inputAmount) calculate();
        }

        function handleFetchError() {
            updateStatusUI('error', 'ì—°ê²° ì‹¤íŒ¨');
            ui.priceDisplay.innerText = "ê°€ê²© ë™ê¸°í™” ì¤‘";
            ui.aiText.innerText = "ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ì–´ìš” ğŸ¥²";
            if(ui.chartLoader) ui.chartLoader.classList.add('hidden');
            if(ui.chartError) ui.chartError.classList.remove('hidden');
        }

        function updateLastTime() { const now = new Date(); const timeStr = now.toLocaleTimeString('ko-KR', { timeZone: 'Asia/Seoul', hour: '2-digit', minute: '2-digit' }); if(document.getElementById('lastUpdatedTime')) document.getElementById('lastUpdatedTime').innerText = `ì—…ë°ì´íŠ¸ë¨ (${timeStr})`; }
        function analyzeAndGenerateMessage(change) {
            if (latestNewsItem && (!localStorage.getItem('sutPay_newsSeen'))) {
                 let cleanSummary = cleanNewsTitle(latestNewsItem.title);
                 ui.aiText.innerHTML = `<span class="inline-flex items-center gap-1 text-purple-600 font-bold mr-1"><i data-lucide="newspaper" class="w-4 h-4"></i></span> ${cleanSummary}`;
                 if(window.lucide) lucide.createIcons();
                 if(newsSource) newsSource.innerText = "Google News";
                 return;
            }
            if(newsSource) newsSource.innerText = "";
            generateTechnicalComment(change);
        }
        function generateTechnicalComment(change) {
            const absChange = Math.abs(change).toFixed(2);
            let category = change >= 5 ? 'surge' : (change >= 0 ? 'rise' : (change >= -5 ? 'drop' : 'plunge'));
            const pctStr = `<span class="text-sm font-medium ml-1 text-slate-500">(+${absChange}%)</span>`;
            const templates = {
                surge: [[`ê°•í•œ ìƒìŠ¹ íë¦„ì´ í™•ì¸ë˜ê³  ìˆì–´ìš” ${pctStr}`]],
                rise: [[`ì•ˆì •ì ì¸ íë¦„ì„ ìœ ì§€í•˜ê³  ìˆì–´ìš” ${pctStr}`]],
                drop: [[`ê°€ê²©ì´ ì†Œí­ ì¡°ì • ë°›ê³  ìˆì–´ìš”`], [`ì ì‹œ ìˆ¨ ê³ ë¥´ê¸° íë¦„ì´ ë‚˜íƒ€ë‚˜ê³  ìˆì–´ìš”`]],
                plunge: [[`ê°€ê²© ì¡°ì • í­ì´ ë‹¤ì†Œ í¬ê²Œ ë‚˜íƒ€ë‚˜ê³  ìˆì–´ìš”`], [`ë‚®ì•„ì§„ ê°€ê²©ìœ¼ë¡œ ê²°ì œ íš¨ìœ¨(êµ¬ë§¤ë ¥)ì´ ëŒ€í­ ìƒìŠ¹í–ˆì–´ìš”`]]
            };
            const msg = templates[category][0][0]; 
            ui.aiText.innerHTML = msg;
        }

        function renderTradingViewChart(data, markers) {
             const container = document.getElementById('tvChartContainer');
             if(!container) return;
             if(ui.chartLoader) ui.chartLoader.classList.add('hidden');
             if(ui.chartError) ui.chartError.classList.add('hidden');
             if (!window.LightweightCharts) return;

             if (!chartInstance) {
                 chartInstance = window.LightweightCharts.createChart(container, {
                     layout: { background: { type: 'solid', color: 'transparent' }, textColor: '#9ca3af' },
                     grid: { vertLines: { visible: false }, horzLines: { visible: false } },
                     rightPriceScale: { borderVisible: false },
                     timeScale: { borderVisible: false, timeVisible: true, secondsVisible: false },
                     crosshair: { vertLine: { labelBackgroundColor: '#9333ea' }, horzLine: { labelBackgroundColor: '#9333ea' } },
                     handleScroll: false, handleScale: false
                 });
                 pastSeries = chartInstance.addAreaSeries({ topColor: 'rgba(156, 163, 175, 0.4)', bottomColor: 'rgba(156, 163, 175, 0.0)', lineColor: '#9ca3af', lineWidth: 2, crosshairMarkerVisible: false });
                 todaySeries = chartInstance.addAreaSeries({ topColor: 'rgba(147, 51, 234, 0.2)', bottomColor: 'rgba(147, 51, 234, 0.0)', lineColor: '#9333ea', lineWidth: 2 });
                 new ResizeObserver(entries => { if(entries.length) { const r = entries[0].contentRect; chartInstance.applyOptions({width: r.width, height: r.height}); } }).observe(container);
             }

             const now = new Date();
             const kstOptions = { timeZone: 'Asia/Seoul', year: 'numeric', month: '2-digit', day: '2-digit' };
             const todayStr = new Intl.DateTimeFormat('ko-KR', kstOptions).format(now);
             const pastData=[], todayData=[];
             
             data.forEach(d => {
                 const date = new Date(d.time*1000);
                 if(new Intl.DateTimeFormat('ko-KR', kstOptions).format(date) === todayStr) todayData.push(d); else pastData.push(d);
             });
             
             if(pastData.length>0 && todayData.length>0) todayData.unshift(pastData[pastData.length-1]);
             
             if(pastSeries) pastSeries.setData(pastData);
             if(todaySeries) {
                 todaySeries.setData(todayData);
                 const todayMarkers = markers.filter(m => new Intl.DateTimeFormat('ko-KR', kstOptions).format(new Date(m.time*1000)) === todayStr);
                 todaySeries.setMarkers(todayMarkers);
             }
             chartInstance.timeScale().fitContent();
        }

        function cleanNewsTitle(t) { return t.replace(/[\(\[\{].*?[\)\]\}]/g, '').trim(); }
        async function fetchNews() { 
            try {
                const rssUrl = encodeURIComponent("https://news.google.com/rss/search?q=SUT+coin+OR+SuperTrust+OR+L2U+platform&hl=ko&gl=KR&ceid=KR:ko");
                const response = await fetch(`https://api.rss2json.com/v1/api.json?rss_url=${rssUrl}`);
                const data = await response.json();
                if (data.items && data.items.length > 0) {
                     const now = Date.now();
                     const recentNews = data.items.filter(item => (now - new Date(item.pubDate).getTime()) < 259200000); // 3 days
                     if (recentNews.length > 0) {
                         const item = recentNews[0];
                         latestNewsItem = { title: cleanNewsTitle(item.title), link: item.link, pubDate: item.pubDate };
                     }
                }
            } catch (e) { console.error("News Error", e); }
        }
        
        function toggleInfo() { const el = document.getElementById('infoText'); if(el) el.classList.toggle('hidden'); }
        function disableButton(b) { b.disabled=true; b.className="flex-1 bg-[#e5e8eb] text-[#b0b8c1] font-bold text-base py-2.5 rounded-xl transition-all flex items-center justify-center gap-2"; }
        function enableButton(b,bg,tc) { b.disabled=false; b.className=`flex-1 ${bg} ${tc} font-bold text-base py-2.5 rounded-xl active:scale-[0.98] transition-all flex items-center justify-center gap-2 shadow-sm`; }
        function calculate() {
            if(!inputAmount || currentSutPrice===0 || priceGrade === 'D') { ui.sutAmountDisplay.innerText='0'; return; }
            const krw = parseInt(inputAmount);
            const dKrw = krw * ((100-discountRate)/100);
            const sut = Math.ceil((dKrw/currentSutPrice)*1000)/1000;
            ui.sutAmountDisplay.innerText = sut.toLocaleString(undefined, {minimumFractionDigits:3, maximumFractionDigits:3});
        }
        function copyResult() {
             const textToCopy = ui.sutAmountDisplay.innerText.replace(/,/g, '');
             const textArea = document.createElement("textarea"); textArea.value = textToCopy; document.body.appendChild(textArea); textArea.select(); document.execCommand("Copy"); textArea.remove();
             showToast(`${textToCopy} SUT ë³µì‚¬ë˜ì—ˆì–´ìš”`);
        }
        
        // Handle Send Transfer (Deep Link)
        function handleSendTransfer() { 
            const amountText = ui.sutAmountDisplay.innerText.replace(/,/g, '');
            const amount = parseFloat(amountText);
            const krwText = ui.krwInput.value;

            if (!amount || amount <= 0) { alert("ê²°ì œí•  ê¸ˆì•¡ì„ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”."); ui.krwInput.focus(); return; }

            // 1. Copy SUT
            const textArea = document.createElement("textarea"); textArea.value = amountText; document.body.appendChild(textArea); textArea.select(); document.execCommand("Copy"); textArea.remove();
            
            // 2. Populate Modal
            ui.sendModalSut.innerText = `${amountText} SUT`;
            ui.sendModalKrw.innerText = `${krwText}ì›`;
            document.getElementById('sendModal').classList.remove('hidden');
            document.getElementById('sendModal').classList.add('flex');

            // 3. Auto Redirect
            setTimeout(directOpenWallet, 2000); 
        }

        // [MODIFIED] Use 'trust://' scheme
        function directOpenWallet() {
             // Try deep link first
             window.location.href = "trust://open";
             
             // Fallback to web link after delay (for desktop or if app not installed)
             setTimeout(() => {
                 // Check if user is still on page (simple check)
                 if (document.hidden) return; 
                 window.location.href = "https://link.trustwallet.com/open";
             }, 1000);
        }

        // [MODIFIED] Copy And Open (From Scan)
        function copyAndOpenWallet() {
             const textArea = document.createElement("textarea"); textArea.value = scannedAddress; document.body.appendChild(textArea); textArea.select(); document.execCommand("Copy"); textArea.remove();
             showToast("ì£¼ì†Œê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤. ì•±ì„ ì¼¤ê²Œìš”."); 
             closeResultModal();
             
             setTimeout(() => {
                 directOpenWallet();
             }, 800);
        }

        function closeResultModal() { document.getElementById('scanResultModal').classList.add('hidden'); }
        function closeManualModal() { document.getElementById('manualOpenModal').classList.add('hidden'); }
        function closeStoreModal() { document.getElementById('storeRedirectModal').classList.add('hidden'); }
        function showToast(m) { const t=document.getElementById('toast'); if(t){ t.innerText=m; t.style.opacity='1'; t.style.transform='translate(-50%,0)'; setTimeout(()=>{t.style.opacity='0';t.style.transform='translate(-50%,-10px)'},2000);}}
        
        function startQrScanner() { 
            isProcessingScan = false; // Reset flag
            document.getElementById('scannerOverlay').classList.remove('hidden'); 
            document.getElementById('scannerOverlay').classList.add('flex'); 
            if(html5QrCode){try{html5QrCode.clear()}catch{}} 
            html5QrCode = new Html5Qrcode("qr-reader"); 
            const config={fps:10, qrbox:(w,h)=>({width:250,height:250})}; 
            html5QrCode.start({facingMode:"environment"}, config, onScanSuccess).catch(err=>{alert("ì¹´ë©”ë¼ ê¶Œí•œ í•„ìš”");}); 
        }
        function stopQrScanner() { 
            if(html5QrCode) html5QrCode.stop().then(()=>document.getElementById('scannerOverlay').classList.add('hidden')).catch(()=>{}); 
            else document.getElementById('scannerOverlay').classList.add('hidden'); 
        }
        function onScanSuccess(d) { 
            if(isProcessingScan) return; 
            isProcessingScan=true; 
            setTimeout(()=>{ 
                scannedAddress=d; 
                stopQrScanner(); 
                
                const inputVal = ui.krwInput.value;
                const hasAmount = inputVal && inputVal !== '0';
                
                if (hasAmount) {
                    ui.scanAmountDetails.classList.remove('hidden');
                    ui.scanModalAddress.innerText = d;
                    ui.scanModalSut.innerText = ui.sutAmountDisplay.innerText + " SUT";
                    ui.scanModalKrw.innerText = inputVal + "ì›";
                } else {
                    ui.scanAmountDetails.classList.add('hidden');
                    ui.scanModalAddress.innerText = d;
                }
                
                document.getElementById('scanResultModal').classList.remove('hidden'); 
                document.getElementById('scanResultModal').classList.add('flex'); 
            }, 500); 
        }
    </script>
</body>
</html>
