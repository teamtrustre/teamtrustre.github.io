<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>trustre 결제 계산기</title>
    <!-- Tailwind CSS (디자인) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 폰트 로드 -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <!-- QR 코드 스캐너 라이브러리 -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #f2f4f6;
            color: #191f28;
            -webkit-tap-highlight-color: transparent;
            height: 100dvh; /* 모바일 브라우저 높이 대응 */
        }

        .num-font {
            font-variant-numeric: tabular-nums;
            letter-spacing: -0.5px;
        }

        .amount-input {
            border: none;
            background: transparent;
            font-size: 2.5rem;
            font-weight: 700;
            color: #333d4b;
            width: 100%;
            outline: none;
            padding: 0;
            caret-color: #9333ea;
            border-radius: 0;
        }
        
        .amount-input::placeholder {
            color: #b0b8c1;
        }

        @keyframes flash {
            0% { color: #9333ea; }
            100% { color: #4e5968; }
        }
        .price-update {
            animation: flash 1s ease-out;
        }
        
        /* QR 스캐너 커스텀 스타일 */
        #qr-reader {
            width: 100%;
            border: none !important;
        }
        #qr-reader__scan_region {
            background: white;
        }
        #qr-reader__dashboard_section_csr button {
            background-color: #9333ea;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: bold;
            margin-top: 10px;
        }
        
        /* 아이폰 하단 바 영역 보호 */
        .pb-safe {
            padding-bottom: env(safe-area-inset-bottom);
        }
    </style>
</head>
<body class="flex flex-col h-full max-w-md mx-auto bg-white shadow-2xl relative">

    <!-- 상단 헤더 -->
    <header class="p-6 pb-2 shrink-0">
        <div class="flex justify-between items-center mb-6">
            <div class="flex items-center gap-2">
                <!-- 로고 이미지 (logo.png가 없으면 아이콘 표시) -->
                <img src="logo.png" alt="trustre" class="h-8 w-auto object-contain" onerror="this.style.display='none'; document.getElementById('fallback-logo').style.display='flex'">
                
                <!-- 로고 없을 때 대체 아이콘 -->
                <div id="fallback-logo" class="w-8 h-8 bg-purple-600 rounded-full flex items-center justify-center hidden">
                    <i data-lucide="zap" class="w-5 h-5 text-white fill-white"></i>
                </div>

                <span class="font-bold text-lg text-slate-800">trustre</span>
            </div>
            
            <div class="flex items-center gap-2">
                <!-- QR 스캔 버튼 -->
                <button onclick="startQrScanner()" class="bg-gray-100 hover:bg-gray-200 p-2 rounded-full transition-colors active:scale-95">
                    <i data-lucide="scan-line" class="w-5 h-5 text-gray-700"></i>
                </button>
                
                <!-- 실시간 시세 -->
                <div class="bg-purple-50 px-3 py-1.5 rounded-full flex items-center gap-1.5">
                    <div id="statusIndicator" class="w-2 h-2 bg-gray-300 rounded-full"></div>
                    <span class="text-xs font-bold text-purple-700 num-font flex items-center gap-1">
                        1 SUT = <span id="currentPrice">...</span>
                    </span>
                </div>
            </div>
        </div>
        
        <h1 class="text-2xl font-bold text-[#191f28] leading-tight">
            결제할 금액을<br>입력해주세요
        </h1>
    </header>

    <!-- 메인 컨텐츠 -->
    <main class="flex-1 flex flex-col px-6 overflow-y-auto">
        
        <!-- 금액 입력창 -->
        <div class="mt-4 relative shrink-0">
            <input type="tel" id="krwInput" class="amount-input num-font" placeholder="0" pattern="[0-9]*" inputmode="numeric">
            <span class="absolute right-0 top-1/2 -translate-y-1/2 text-2xl font-bold text-[#333d4b] pointer-events-none">원</span>
        </div>
        
        <!-- 한글 금액 표기 -->
        <div id="krwKorean" class="text-sm text-gray-400 font-medium text-right h-5 mb-2 shrink-0"></div>

        <!-- 결과 카드 -->
        <div class="bg-[#f2f4f6] rounded-2xl p-5 mt-2 transition-all duration-300 transform scale-95 opacity-50 shrink-0" id="resultCard">
            <div class="flex justify-between items-center mb-2">
                <span class="text-sm text-[#4e5968] font-medium">보내야 할 코인</span>
                <button onclick="fetchSutPrice()" class="text-xs text-[#8b95a1] flex items-center gap-1 bg-white px-2 py-1 rounded shadow-sm border border-gray-100 active:bg-gray-50">
                    <i data-lucide="refresh-cw" class="w-3 h-3" id="refreshIcon"></i> 시세 갱신
                </button>
            </div>
            <div class="flex items-baseline gap-1">
                <span id="sutAmount" class="text-3xl font-bold text-purple-600 num-font">0</span>
                <span class="text-lg font-bold text-purple-600">SUT</span>
            </div>
            <p class="text-xs text-[#8b95a1] mt-2 flex items-center gap-1">
                <i data-lucide="info" class="w-3 h-3"></i> 최대 1~2원 오차
            </p>
        </div>
        
        <div class="h-8"></div>
    </main>

    <!-- 하단 버튼 영역 -->
    <div class="p-4 pb-6 bg-white border-t border-gray-100 shrink-0 z-30 relative flex gap-3 pb-safe">
        <button id="copyBtn" class="flex-1 bg-[#e5e8eb] text-[#b0b8c1] font-bold text-lg py-4 rounded-xl active:scale-[0.98] transition-all disabled:opacity-50 disabled:scale-100 flex items-center justify-center gap-2" disabled onclick="copyResult()">
            수량 복사
        </button>
        <button id="walletBtn" class="flex-1 bg-[#e5e8eb] text-[#b0b8c1] font-bold text-lg py-4 rounded-xl active:scale-[0.98] transition-all disabled:opacity-50 disabled:scale-100 flex items-center justify-center gap-2" disabled onclick="openTrustWallet()">
            <img src="https://trustwallet.com/assets/images/favicon.png" class="w-6 h-6 rounded-full" alt="Trust" onerror="this.style.display='none'; document.getElementById('walletIconFallback').style.display='block'">
            <i data-lucide="wallet" id="walletIconFallback" class="w-5 h-5 hidden"></i>
            송금하기
        </button>
    </div>

    <!-- QR 스캐너 모달 -->
    <div id="scannerOverlay" class="fixed inset-0 bg-black bg-opacity-95 z-50 hidden flex-col items-center justify-center">
        <div class="text-white text-lg font-bold mb-4">QR 코드를 비춰주세요</div>
        <div class="w-full max-w-sm px-4">
            <div id="qr-reader" class="rounded-xl overflow-hidden bg-white"></div>
        </div>
        <button onclick="stopQrScanner()" class="mt-8 px-6 py-2 bg-white/20 text-white rounded-full text-sm font-bold backdrop-blur-sm">
            닫기
        </button>
    </div>

    <!-- 스캔 완료 모달 -->
    <div id="scanResultModal" class="fixed inset-0 bg-black/60 z-[60] hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl p-6 w-full max-w-xs text-center shadow-2xl transform transition-all scale-100">
            <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <i data-lucide="check" class="w-6 h-6 text-green-600"></i>
            </div>
            <h3 class="text-xl font-bold text-gray-900 mb-2">주소 스캔 완료!</h3>
            <p class="text-xs text-gray-500 mb-4 break-all bg-gray-50 p-3 rounded-lg border border-gray-100" id="scannedAddressDisplay">
                0x...
            </p>
            <div class="space-y-2">
                <button onclick="copyAndOpenWallet()" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 rounded-xl shadow-lg active:scale-95 transition-all">
                    주소 복사하고 지갑 열기
                </button>
                <button onclick="closeResultModal()" class="w-full text-gray-400 text-sm py-2">
                    닫기
                </button>
            </div>
        </div>
    </div>

    <!-- 알림 토스트 -->
    <div id="toast" class="fixed top-6 left-1/2 -translate-x-1/2 bg-[rgba(51,61,75,0.9)] text-white px-5 py-3 rounded-full text-sm font-medium opacity-0 transition-opacity duration-300 pointer-events-none z-[70] shadow-lg backdrop-blur-sm whitespace-nowrap">
        복사되었습니다
    </div>

    <!-- 스크립트 -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
        let currentSutPrice = 0; 
        let inputAmount = '';
        let isPriceLoaded = false;
        let html5QrCode;
        let scannedAddress = '';
        let isScannerRunning = false;

        const krwInput = document.getElementById('krwInput');
        const krwKorean = document.getElementById('krwKorean');
        const sutAmountDisplay = document.getElementById('sutAmount');
        const currentPriceDisplay = document.getElementById('currentPrice');
        const resultCard = document.getElementById('resultCard');
        const copyBtn = document.getElementById('copyBtn');
        const walletBtn = document.getElementById('walletBtn');
        const statusIndicator = document.getElementById('statusIndicator');
        const refreshIcon = document.getElementById('refreshIcon');
        const scannerOverlay = document.getElementById('scannerOverlay');
        const scanResultModal = document.getElementById('scanResultModal');
        const scannedAddressDisplay = document.getElementById('scannedAddressDisplay');

        // 초기화
        window.addEventListener('load', function() {
            if (window.lucide) { lucide.createIcons(); }
            fetchSutPrice();
            setInterval(fetchSutPrice, 60000);
        });

        // 1. 입력 감지 (숫자만, 콤마 자동)
        krwInput.addEventListener('input', function(e) {
            let val = e.target.value.replace(/[^0-9]/g, '');
            if (val.length > 1 && val.startsWith('0')) {
                val = val.substring(1);
            }
            inputAmount = val;
            if (val) {
                e.target.value = Number(val).toLocaleString();
            } else {
                e.target.value = '';
            }
            updateScreenState();
        });

        // 2. 화면 상태 업데이트
        function updateScreenState() {
            if (!inputAmount || inputAmount === '0') {
                krwKorean.innerText = '';
                resultCard.classList.add('opacity-50', 'scale-95');
                resultCard.classList.remove('opacity-100', 'scale-100', 'bg-purple-50');
                resultCard.classList.add('bg-[#f2f4f6]');
                disableButton(copyBtn);
                disableButton(walletBtn);
                sutAmountDisplay.innerText = '0';
            } else {
                const numVal = Number(inputAmount);
                krwKorean.innerText = convertToKoreanNumber(numVal) + '원';
                resultCard.classList.remove('opacity-50', 'scale-95', 'bg-[#f2f4f6]');
                resultCard.classList.add('opacity-100', 'scale-100', 'bg-purple-50');
                enableButton(copyBtn, 'bg-gray-200', 'text-gray-800');
                enableButton(walletBtn, 'bg-purple-600', 'text-white');
                calculate();
            }
        }

        // 3. 가격 가져오기
        async function fetchSutPrice() {
            currentPriceDisplay.style.opacity = '0.5';
            statusIndicator.classList.remove('bg-green-500', 'animate-pulse');
            statusIndicator.classList.add('bg-yellow-400', 'animate-pulse');
            if(refreshIcon) refreshIcon.classList.add('animate-spin');

            try {
                const response = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=super-trust&vs_currencies=krw');
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();
                
                if (data['super-trust'] && data['super-trust'].krw) {
                    currentSutPrice = data['super-trust'].krw;
                    isPriceLoaded = true;
                    updatePriceDisplay(true);
                } else {
                    throw new Error('Price data not found');
                }
            } catch (error) {
                console.error("Failed to fetch price:", error);
                statusIndicator.classList.remove('bg-yellow-400', 'bg-green-500');
                statusIndicator.classList.add('bg-red-500');
                currentPriceDisplay.innerText = currentSutPrice > 0 ? currentSutPrice.toLocaleString() + " KRW (갱신 실패)" : "연결 실패";
            } finally {
                currentPriceDisplay.style.opacity = '1';
                if(refreshIcon) refreshIcon.classList.remove('animate-spin');
            }
        }

        function updatePriceDisplay(success) {
            if (success) {
                statusIndicator.classList.remove('bg-yellow-400', 'bg-red-500');
                statusIndicator.classList.add('bg-green-500', 'animate-pulse');
                currentPriceDisplay.innerText = currentSutPrice.toLocaleString() + " KRW";
                const parent = currentPriceDisplay.parentElement;
                parent.classList.remove('price-update');
                void parent.offsetWidth; 
                parent.classList.add('price-update');
                if (inputAmount.length > 0) calculate();
            }
        }

        // 4. QR 스캐너
        function startQrScanner() {
            scannerOverlay.classList.remove('hidden');
            scannerOverlay.classList.add('flex');
            if (html5QrCode) { try { html5QrCode.clear(); } catch(e){} }

            html5QrCode = new Html5Qrcode("qr-reader");
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };
            
            html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess)
            .then(() => { isScannerRunning = true; })
            .catch(err => {
                console.error("QR Start Error", err);
                isScannerRunning = false;
                alert("카메라를 시작할 수 없습니다. 권한을 확인해주세요.");
                scannerOverlay.classList.add('hidden');
                scannerOverlay.classList.remove('flex');
                try { html5QrCode.clear(); } catch(e){}
            });
        }

        function onScanSuccess(decodedText, decodedResult) {
            console.log(`Scan result: ${decodedText}`);
            scannedAddress = decodedText; 
            stopQrScanner(); 
            scannedAddressDisplay.innerText = decodedText;
            scanResultModal.classList.remove('hidden');
        }

        function stopQrScanner() {
            if (html5QrCode) {
                if(isScannerRunning) {
                    html5QrCode.stop().then(() => {
                        html5QrCode.clear();
                        isScannerRunning = false;
                        scannerOverlay.classList.add('hidden');
                        scannerOverlay.classList.remove('flex');
                    }).catch(err => {
                        isScannerRunning = false;
                        scannerOverlay.classList.add('hidden');
                        scannerOverlay.classList.remove('flex');
                        try { html5QrCode.clear(); } catch(e){}
                    });
                } else {
                    try { html5QrCode.clear(); } catch(e){}
                    scannerOverlay.classList.add('hidden');
                    scannerOverlay.classList.remove('flex');
                }
            } else {
                scannerOverlay.classList.add('hidden');
                scannerOverlay.classList.remove('flex');
            }
        }

        // 5. 실행 및 복사
        function copyAndOpenWallet() {
            copyTextToClipboard(scannedAddress);
            showToast("주소 복사 완료! 지갑을 엽니다.");
            window.location.href = "https://link.trustwallet.com/open";
            closeResultModal();
        }

        function closeResultModal() {
            scanResultModal.classList.add('hidden');
        }

        function copyTextToClipboard(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand("Copy");
            textArea.remove();
        }

        function convertToKoreanNumber(num) {
            if(num === 0) return '';
            const unitWords = ['', '만 ', '억 ', '조 '];
            let result = '';
            let temp = num;
            
            for (let i = 0; i < unitWords.length; i++) {
                let chunk = temp % 10000;
                temp = Math.floor(temp / 10000);
                if (chunk > 0) {
                    let chunkStr = '';
                    if (chunk >= 1000) {
                        let cheon = Math.floor(chunk / 1000);
                        let rest = chunk % 1000;
                        chunkStr = cheon + '천';
                        if (rest > 0) chunkStr += ' ' + rest;
                    } else {
                        chunkStr = String(chunk);
                    }
                    result = chunkStr + unitWords[i] + result;
                }
            }
            return result.trim();
        }

        function disableButton(btn) {
            btn.disabled = true;
            btn.className = "flex-1 bg-[#e5e8eb] text-[#b0b8c1] font-bold text-lg py-4 rounded-xl transition-all flex items-center justify-center gap-2";
        }

        function enableButton(btn, bgColor, textColor) {
            btn.disabled = false;
            btn.className = `flex-1 ${bgColor} ${textColor} font-bold text-lg py-4 rounded-xl active:scale-[0.98] transition-all flex items-center justify-center gap-2 shadow-sm`;
        }

        function calculate() {
            if (!inputAmount || currentSutPrice === 0) {
                sutAmountDisplay.innerText = '0';
                return;
            }
            const krw = parseInt(inputAmount);
            const rawSut = krw / currentSutPrice;
            const roundedSut = Math.ceil(rawSut * 1000) / 1000;
            sutAmountDisplay.innerText = roundedSut.toLocaleString(undefined, {
                minimumFractionDigits: 3,
                maximumFractionDigits: 3
            });
        }

        function copyResult() {
            const textToCopy = sutAmountDisplay.innerText.replace(/,/g, '');
            copyTextToClipboard(textToCopy);
            showToast(`${textToCopy} SUT 복사완료`);
        }

        function openTrustWallet() {
            window.location.href = "https://link.trustwallet.com/open";
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            if(!toast) return;
            toast.innerText = message;
            toast.style.opacity = '1';
            toast.style.transform = 'translate(-50%, 0)';
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translate(-50%, -10px)';
            }, 2000);
        }
    </script>
</body>
</html>